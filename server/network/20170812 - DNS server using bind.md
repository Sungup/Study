# Build up DNS server using bind service

## Background

* 내부 네트워크 Address: 192.168.11.0/24
* DNS를 올릴 서버의 주소: 192.168.11.70
* DNS를 통해 연결할 서버들의 주소
  * domain: 192.168.11.70
  * www: 192.168.11.101
  * virt: 192.168.11.102
* 내부 네트워크 이름: yourdomain.com

## Install Packages

아래의 명령어로 Bind 서버 설치.

```Bash
sudo yum install -y bind
```

## Setup bind

/etc/named.conf 에서 yourdomain.com 을 위한 Zone 파일을 추가한다.

### /etc/named.conf

변경사항이 많은 관계로 변경사항에 대한 diff 파일로 대체한다.

```diff
$ sudo diff -uprN /etc/named.conf{.org,}
--- /etc/named.conf.org 2016-05-02 15:15:34.378542110 +0900
+++ /etc/named.conf     2016-05-02 15:48:28.273186281 +0900
@@ -8,13 +8,13 @@
 //

 options {
-       listen-on port 53 { 127.0.0.1; };
+       listen-on port 53 { 127.0.0.1; 192.168.11.0/24;};
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
-       allow-query     { localhost; };
+       allow-query     { localhost; 192.168.11.0/24;};

        /*
         - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
@@ -26,7 +26,7 @@ options {
           attacks. Implementing BCP38 within your network would greatly
           reduce such attack surface
        */
-       recursion yes;
+       recursion no;

        dnssec-enable yes;
        dnssec-validation yes;
@@ -47,10 +47,17 @@ logging {
         };
 };

+/*
 zone "." IN {
        type hint;
        file "named.ca";
 };
+*/
+
+zone "yourdomain.com" IN {
+       type master;
+       file "yourdomain.com.zone";
+};

 include "/etc/named.rfc1912.zones";
 include "/etc/named.root.key";
```

### /var/named/yourdomain.com.zone

yourdomain.com을 위해 domain, www 및 virt 라고 하는 Host 명을 NS에 등록한다. 내부 네트워크네 있는 192.168.11.70이 domain.yourdomain.com, 192.168.11.101이 www.yourdomain.com, 192.167.11.102가 virt.yourdomain.com으로 등록한다.

```Bash
$ sudo cat /var/named/yourdomain.com.zone
$TTL    86400

@       IN      SOA     yourdomain.com root.yourdomain.com    (
        2017081219
        3600
        900
        604800
        86400
)

@               IN      NS      domain
domain          IN      A       192.168.11.70
www             IN      A       192.168.11.101
virt            IN      A       192.168.11.102
```

### bind 서버 설정 검증

named-checkconf로 /etc/named.conf를 검증한다.

```Bash
$ sudo named-checkconf
```

named-checkzone으로 zond 파일을 검증한다.

```Bash
$ sudo named-checkzone yourdomain.com /var/named/yourdomain.com.zone
zone yourdomain.com/IN: loaded serial 2017081219
OK
```

## Firewall 설정

53/tcp와 53/udp의 Port를 개방한다.

```Bash
sudo firewall-cmd --add-service=dns --permanent
sudo firewall-cmd --reload
```

## named 서버 기동 및 등록

systemctl을 통해 named 서버를 등록한다.

```Bash
sudo systemctl enable named
sudo systemctl start named
```

## Linux Client에서 DNS 서버 설정

/etc/resolv.conf에 DNS 서버 설정을 추가한다. 내부 네트워크용으로 DNS서버인 192.168.11.70 외에 외부 네트워크 용으로 Default DNS 서버를 추가한다.

```Bash
cat /etc/resolv.conf
# Generated by NetworkManager
search my.net
nameserver 192.168.11.70
nameserver 192.168.11.1
```
